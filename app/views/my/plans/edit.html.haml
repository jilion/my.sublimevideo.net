= title("Plan for #{truncate_middle(@site.hostname, length: 23)}")
= render '/layouts/sites_select_title'

#site.edit
  = render '/layouts/segmented_menu'

  - if @site.hostname.blank?
    .info_message_box= raw "Please #{link_to("add a hostname", [:edit, @site])} before choosing a paid plan."
  - elsif @site.pending_plan_id? && !@site.pending_plan_id_changed?
    - if @site.invoices_failed?
      .info_message_box= raw t('site.plan.upgrade_in_progress_failed_link', link: link_to("your invoice", [@site, :invoices]))
    - elsif @site.invoices_open?
      .info_message_box= raw t('site.plan.upgrade_in_progress_open_link', link: link_to("your invoice", [@site, :invoices]))
    - elsif @site.invoices_waiting?
      .info_message_box= t 'site.plan.upgrade_in_progress_waiting_link'
    - else
      .info_message_box= t 'site.plan.upgrade_in_progress'
  - elsif @site.in_sponsored_plan?
    .info_message_box
      %p= raw "Your plan is currently sponsored by Jilion. If you have any questions, please #{mail_to "sales@sublimevideo.net", "contact us"}."
  - else
    - if @site.errors.empty? && @site.next_cycle_plan_id?
      #next_cycle_plan_box
        %p= t 'site.plan.next_cycle_will_start_on', plan_title: @site.next_cycle_plan.title(always_with_cycle: true), date: l(@site.plan_cycle_ended_at.tomorrow.midnight, format: :named_date)
        = button_to "Cancel", [@site, :plan], method: 'delete', class: "cancel_button submit_dynamic_button"

    #change_plan_box.section_box
      = form_for @site, url: site_plan_path(@site), html: { id: "edit_site_plan", "data-password-protected" => @site.in_paid_plan? && !@site.trial_not_started_or_in_trial?, onsubmit: "$('site_submit').disable();" } do |f|

        = password_box(resource: @site, f: f, cancel_url: edit_site_plan_path(@site)) if current_password_needed_error?(@site)

        = render 'fields', f: f

        = render 'my/sites/skip_trial_box', site: @site, f: f

        = render 'my/sites/billing_infos_box'

        / #billing_infos{ 'data-state' => credit_card_state(current_user), style: 'display:none' }
        /   #billing_infos_none{ style: 'display:none' }
        /     = "In order to pay immediately, please fill your billing information first and come back here to buy your plan."
        /     %br
        /     = raw t("app.please_link", link: link_to("fill your billing information", [:edit, :billing], class: "hl")) + '.'
        /   #billing_infos_expired{ style: 'display:none' }
        /     = t('user.credit_card.expired')
        /     = raw t("app.please_link", link: link_to(t('app.update_it'), [:edit, :billing], class: "hl")) + " and come back here to buy your plan."
        /   #billing_infos_present{ style: 'display:none' }
        /     #credit_card_summary
        /       %strong Credit card used
        /       = render 'my/billings/cc_summary', user: current_user

        = render 'plan_change_messages'
        .spacer

        .actions.center
          = f.submit("Update plan", class: "submit big", id: 'site_submit') unless @site.in_custom_plan?