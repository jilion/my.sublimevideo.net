= title("Plan for #{truncate_middle(@site.hostname_or_token, length: 23)}")
= render '/layouts/sites_select_title'

#site.edit
  = render '/layouts/segmented_menu'

  - if @site.hostname.blank?
    .notice= raw t('site.plan.hostname_needed_for_paid_plan', link: link_to("add a hostname", [:edit, @site]))
  - elsif @site.invoices_failed?
    .notice= raw t('site.plan.upgrade_in_progress_failed_link', link: link_to("your invoice", [@site, :invoices]))
  - elsif @site.invoices_open?
    .notice= raw t('site.plan.upgrade_in_progress_open_link', link: link_to("here", [@site, :invoices]))
  - elsif @site.invoices_waiting?
    .notice= t 'site.plan.upgrade_in_progress_waiting_link'
  - elsif @site.pending_plan_id? && !@site.pending_plan_id_changed?
    .notice= t 'site.plan.upgrade_in_progress'
  - elsif @site.in_sponsored_plan?
    .notice
      %p= raw "Your plan is currently sponsored, if you have any questions, please email #{mail_to t('mailer.sales.email_full').html_safe, t('mailer.sales.email')}."
  - else
    - if @site.errors.empty? && @site.next_cycle_plan_id?
      #next_cycle_plan_box.notice
        %p= raw t('site.plan.next_cycle_will_start_on', plan_title: @site.next_cycle_plan.title(always_with_cycle: true), date: l(@site.plan_cycle_ended_at.tomorrow.midnight, format: :named_date))
        = button_to "Cancel", [@site, :plan], method: 'delete', class: "cancel_button submit_dynamic_button"

    #change_plan_box.section_box
      = form_for @site, url: site_plan_path(@site), html: { id: "edit_site_plan", "data-password-protected" => @site.in_paid_plan? && !@site.trial_not_started_or_in_trial?, onsubmit: "$('site_submit').disable();" } do |f|

        = password_box(resource: @site, f: f, cancel_url: edit_site_plan_path(@site)) if current_password_needed_error?(@site)

        = render 'fields', f: f

        = render 'my/sites/skip_trial_box', site: @site, f: f

        = render 'my/sites/billing_info_box'

        = render 'plan_change_messages'
        .spacer

        .actions.center= f.submit("Update plan", class: "submit green_button", id: 'site_submit', style: 'display:none') unless @site.in_custom_plan?