= title("Plan for #{truncate_middle(@site.hostname, length: 23)}")
= content_header(site_quick_switch_trigger(@site))

#site.edit
  = render '/layouts/site_quick_switch'
  = render '/layouts/segmented_menu'

  - if @site.hostname.blank?
    .info_message_box= raw "Please #{link_to("add a hostname", [:edit, @site])} before choosing a paid plan."
  - elsif @site.pending_plan_id? && !@site.pending_plan_id_changed?
    - if @site.invoices_failed?
      .info_message_box= raw t('site.plan.upgrade_in_progress_failed_link', link: link_to("your invoice", [@site, :invoices]))
    - elsif @site.invoices_open?
      .info_message_box= raw t('site.plan.upgrade_in_progress_open_link', link: link_to("your invoice", [@site, :invoices]))
    - elsif @site.invoices_waiting?
      .info_message_box= t 'site.plan.upgrade_in_progress_waiting_link'
    - else
      .info_message_box= t 'site.plan.upgrade_in_progress'
  - elsif @site.in_sponsored_plan?
    .info_message_box
      %p= raw "Your plan is currently sponsored by Jilion. If you have any questions, please #{mail_to "sales@sublimevideo.net", "contact us"}."
  - else
    - if @site.errors.empty? && @site.next_cycle_plan_id?
      #next_cycle_plan_box
        %p= t 'site.plan.next_cycle_will_start_on', plan_title: @site.next_cycle_plan.title(always_with_cycle: true), date: l(@site.plan_cycle_ended_at.tomorrow.midnight, format: :named_date)
        = button_to "Cancel", [@site, :plan], method: 'delete', class: "cancel_button submit_dynamic_button"

    #change_plan_box.section_box
      = form_for @site, url: site_plan_path(@site), html: { id: "edit_site_plan", "data-password-protected" => @site.in_paid_plan? && !@site.trial_not_started_or_in_trial?, onsubmit: "$('site_submit').disable();" } do |f|

        = password_box(resource: @site, f: f, cancel_url: edit_site_plan_path(@site)) if current_password_needed_error?(@site)

        = render 'fields', f: f

        = render 'plan_change_messages'

        = render('sites/cc_fields', site: @site, f: f) unless @site.trial_not_started_or_in_trial? || @site.in_custom_plan?
        .spacer

        .actions.center
          = f.submit("Update plan", class: "submit big") unless @site.in_custom_plan?