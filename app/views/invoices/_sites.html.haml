%table#detail
  %tr
    %th.left= "Site"
    %th.left= "Details"
    %th= "Amount (US $)"
  - invoice_items_grouped_by_site(invoice).each do |site, invoice_items|
    - plan_invoice_item    = get_plan_invoice_item(invoice_items)
    - overage_invoice_item = get_overage_invoice_item(invoice_items)
    - addons_invoice_items = get_addons_invoice_items_grouped_by_item(invoice_items)
    %tr
      %td.title{ :rowspan => (1 + addons_invoice_items.size) + (overage_invoice_item.amount > 0 ? 1 : 0) }
        %h3= site.hostname

      = render('/invoices/plan_invoice_item', :plan_invoice_item => plan_invoice_item)
    = render('/invoices/overage_invoice_item', :overage_invoice_item => overage_invoice_item) if overage_invoice_item.amount > 0
    - addons_invoice_items_amount = addons_invoice_items.sum { |addon, addon_invoice_items| addon_invoice_items.sum(&:amount) }
    - if addons_invoice_items.present?
      - addons_invoice_items.each do |addon, addon_invoice_items|
        %tr
          %td.table_wrap
            %table
              %tr
                %td{ :colspan => 2 }
                  %h4
                    = "#{addon.name} (#{display_amount(addon.price)} per month)"
                    - if addon_invoice_items.sum(&:percentage) < 1
                      %em=" - #{display_percentage(addon_invoice_items.sum(&:percentage))} of usage"
                - addon_invoice_items.sort_by { |invoice_item| invoice_item.ended_at }.each do |addon_invoice_item|
                  %tr
                    %td
                      %p.period= "Period from #{invoice_item_dates(addon_invoice_item)}"
          %td.total
            = display_amount(addons_invoice_items_amount)
    %tr.subtotal
      %td.right{ :colspan => 2 }
        = "Subtotal for"
        %strong= site.hostname
      %td.total= display_amount(plan_invoice_item.amount + overage_invoice_item.amount + addons_invoice_items_amount)
  = render "/invoices/total", :invoice => invoice