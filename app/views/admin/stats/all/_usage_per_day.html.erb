<%
interval = 1.day
moving_average_days_count = moving_average_length
title    = "VPV per day, total and averages between #{l(range_start_date.to_date, :format => :small)} and #{l(range_end_date, :format => :small)}"

usages = Stat.usages(range_start_date - (moving_average_days_count-1).days, range_end_date)
usages = ((range_start_date - (moving_average_days_count-1).days).to_date..range_end_date.to_date).inject([]) do |memo, day|
  usage_on_day = usages.detect { |u| u["day"].to_date == day }
  memo << (usage_on_day ? usage_on_day : { "day" => day })
end

loader_usages  = usages.map { |u| u["loader_usage"].to_i }
invalid_usages = usages.map { |u| u["invalid_usage"].to_i }
dev_usages     = usages.map { |u| u["dev_usage"].to_i }
main_usages    = usages.map { |u| u["main_usage"].to_i }
all_usages     = usages.map { |u| u["all_usage"].to_i }

total_main_usages = main_usages[moving_average_days_count-1..-1].inject([]) { |memo, u| memo << ((memo.last || 0) + u) }
total_all_usages  = all_usages[moving_average_days_count-1..-1].inject([]) { |memo, u| memo << ((memo.last || 0) + u) }
%>
<script type = "text/javascript" charset="utf-8">
  document.observe("dom:loaded", function() {
    new Highcharts.Chart({
      chart: {
        renderTo: 'usage_per_day',
        marginTop: 90,
        marginBottom: 40,
        backgroundColor: '#EEEEEE',
        animation: false
      },
      title: {
        text: '<%= title %>'
      },
      xAxis: {
        type: 'datetime',
        tickInterval: <%= 1.day * 1000 %>,
        labels: {
          step: <%= (((range_end_date - range_start_date) / 1.day) / 12).floor %>
        }
      },
      yAxis: {
        title: {
          text: 'Video-page views',
          margin: 50
        },
        labels: {
          formatter: function() {
            return Highcharts.numberFormat(this.value, 0);
          }
        }
      },
      legend: {
        verticalAlign: 'top',
        y: 30,
        width: 640,
        symbolWidth: 12,
        backgroundColor: '#FFFFFF',
        borderColor: '#CCCCCC'
      },
      tooltip: {
        borderWidth: 0,
        backgroundColor: "rgba(0, 0, 0, .70)",
        style: {
        	color: '#FFFFFF',
        	padding: '5px'
        },
        formatter: function() {
          var date = "<strong>" + Highcharts.dateFormat("%B %e,  %Y", this.x) + "</strong><br/><br/>";
          var percentage_of_total = '';
          var percentage_of_limit = '';
          
          if (["Invalid", "Invalid cached", "Dev", "Dev cached", "Main", "Main cached"].indexOf(this.series.name) != -1) {
            percentage_of_total = " (" + Highcharts.numberFormat(this.percentage, 1) + "%)";
            percentage_of_total += "<br/>Total: " + Highcharts.numberFormat(this.total, 0);
          }
          else if (this.series.name == "Loader") {
            percentage_of_limit = "<br/>Loader / Player: " + Highcharts.numberFormat((this.y / (this.total - this.y)), 1);
          }
          
          return date + this.series.name + ": " + Highcharts.numberFormat(this.y, 0) + percentage_of_total + percentage_of_limit;
        }
      },
      series: [
        {
          type: 'column',
          name: 'Loader',
          visible: false,
          color: '#AAAA00',
          data: <%= loader_usages[moving_average_days_count-1..-1] %>
        },
        {
          type: 'column',
          name: 'Invalid cached',
          color: '#FF8800',
          data: <%= usages.map { |u| u["invalid_usage_cached"].to_i }[moving_average_days_count-1..-1] %>
        },
        {
          type: 'column',
          name: 'Invalid',
          color: '#FF0000',
          data: <%= invalid_usages[moving_average_days_count-1..-1] %>
        },
        {
          type: 'column',
          name: 'Dev cached',
          color: '#11CC11',
          data: <%= usages.map { |u| u["dev_usage_cached"].to_i }[moving_average_days_count-1..-1] %>
        },
        {
          type: 'column',
          name: 'Dev',
          color: '#33FF33',
          data: <%= dev_usages[moving_average_days_count-1..-1] %>
        },
        {
          type: 'column',
          name: 'Main cached',
          color: '#0088FF',
          data: <%= usages.map { |u| u["main_usage_cached"].to_i }[moving_average_days_count-1..-1] %>
        },
        {
          type: 'column',
          name: 'Main',
          color: '#0000FF',
          data: <%= main_usages[moving_average_days_count-1..-1] %>
        },
        
        {
          type: 'line',
          name: 'AVG Loader',
          visible: false,
          color: '#FFFF00',
          data: <%= moving_average(loader_usages, moving_average_days_count) %>
        },
        {
          type: 'line',
          name: 'AVG Invalid',
          visible: false,
          color: '#FFCC33',
          data: <%= moving_average(invalid_usages, moving_average_days_count) %>
        },
        {
          type: 'line',
          name: 'AVG Dev',
          visible: false,
          color: '#009900',
          data: <%= moving_average(dev_usages, moving_average_days_count) %>
        },
        {
          type: 'line',
          name: 'AVG Total',
          color: '#00FFFF',
          data: <%= moving_average(all_usages, moving_average_days_count) %>
        },
        
        {
          type: 'line',
          name: 'TOT Main',
          visible: false,
          data: <%= total_main_usages %>
        },
        {
          type: 'line',
          name: 'TOT All',
          visible: false,
          data: <%= total_all_usages %>
        }
      ],
      plotOptions: {
        column: {
          pointInterval: <%= interval * 1000 %>,
          pointStart: <%= range_start_date.to_i * 1000 %>,
          stacking: 'normal',
          pointPadding: 0,
          shadow: false
        },
        line: {
          pointInterval: <%= interval * 1000 %>,
          pointStart: <%= range_start_date.to_i * 1000 %>,
          marker: {
            enabled: false
          },
          shadow: false,
          states: {
            hover: {
              marker: {
                enabled: true
              }
            }
          }
        }
      },
      credits: {
        enabled: true,
        text: "Generation time: <%= Time.now.to_s(:format => :fully_full) %> / Copyright © <%= Date.today.year %> - SublimeVideo®",
        href: "http://sublimevideo.net"
      }
    });
  });
</script>
<div id="usage_per_day" style="width:100%; height:600px;"></div>