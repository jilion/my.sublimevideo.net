<%
invoices = ::Invoice.between(@date_range_from, @date_range_to).order(:created_at.asc)

monthly_paid_invoices = Stat::Invoice.timeline(invoices.includes(:plan_invoice_items).paid.select { |i| i.paid_plan.monthly? }, @date_range_from, @date_range_to)
yearly_paid_invoices  = Stat::Invoice.timeline(invoices.includes(:plan_invoice_items).paid.select { |i| i.paid_plan.yearly? }, @date_range_from, @date_range_to)
open_invoices         = Stat::Invoice.timeline(invoices.open, @date_range_from, @date_range_to)
failed_invoices       = Stat::Invoice.timeline(invoices.failed, @date_range_from, @date_range_to)
refunded_invoices     = Stat::Invoice.timeline(invoices.refunded, @date_range_from, @date_range_to)
waiting_invoices      = Stat::Invoice.timeline(invoices.waiting, @date_range_from, @date_range_to)



unless invoices.empty?
  graph = Graph.new do |g|
    g.option(chart: chart('timeline_invoices', margin_top: 100))
    g.option(title: { text: "Invoices" })
    g.option(subtitle: usage_date_subtitle(invoices.first.created_at, invoices.last.created_at, date_format: :month_fullyear))
    g.option(legend: legend(y: 40))
    g.option(xAxis: x_axis(@date_range_from, @date_range_to))

    g.raw_option(%(yAxis: {
      title: {
        text: 'US $',
        margin: 70,
        rotation: 0
      },
      showFirstLabel: false,
      min: 0,
      labels: {
        formatter: function() { return "$" + Highcharts.numberFormat(this.value / 100, 0); }
      },
      lineWidth: 1
    }))
    g.raw_option(%(tooltip: {
      borderWidth: 0,
      backgroundColor: "rgba(0, 0, 0, .70)",
      style: {
        color: '#FFFFFF',
        padding: '5px'
      },
      formatter: function() {
        return "<strong>" + Highcharts.dateFormat("%B %e,  %Y", this.x) + "</strong><br/>" + this.series.name + ": <strong>$" + Highcharts.numberFormat(this.y / 100, 2) + " of $" + Highcharts.numberFormat(this.total / 100, 2) + " (" + Highcharts.numberFormat(this.percentage, 1) + "%)</strong>";
      },
      borderWidth: 1
    }))
    
    g.option(series: [
      serie(yearly_paid_invoices, 'Paid invoices (yearly)', '#0000FF', :type => 'area', :color => '#5e33c8'),
      serie(monthly_paid_invoices, 'Paid invoices (monthly)', '#0000FF', :type => 'area', :color => '#7941ff'),
      serie(refunded_invoices, 'Refunded invoices', '#1C1', :type => 'area', :color => '#ff8000'),
      serie(failed_invoices, 'Failed invoices', '#89A54E', :type => 'area', :color => '#fe2617'),
      serie(open_invoices, 'Open invoices', '#A1A', :type => 'area', :color => '#EEE'),
      serie(waiting_invoices, 'Waiting invoices', '#00FF00', :type => 'area', :color => '#AAA')
    ].flatten)
    # g.option(plotOptions: plot_options(@date_range_from.end_of_month, 1.month, marker: true, linear: true))
    g.option(plotOptions: plot_options(@date_range_from))
    g.option(credits: credits)
  end
end
%>

<div id="timeline_invoices" style="width: 100%; height: 400px;"><%= raw graph.draw %></div>
