<%
usages = Stat::SiteUsage.timeline(@date_range_from, @date_range_to, { :site_id => site.try(:id) })
plans  = Plan.all

graph = Graph.new do |g|
  g.option(chart: chart('timeline_usage'))
  g.option(title: { text: "VPV per day, total and averages for #{site.hostname.present? ? hostname_with_path_and_wildcard(site) : site.token}" })
  g.option(subtitle: usage_date_subtitle(@date_range_from, @date_range_to))
  g.option(legend: legend)
  g.option(xAxis: {
    type: 'datetime', showFirstLabel: true, showLastLabel: true, gridLineWidth: 1,
    dateTimeLabelFormats: {
    	day: '%e %b',
    	week: '%e %b'
    },
    labels: {
      y: 15
    },
    plotBands: [{
        color: '#FFFFD9',
        from: (Time.now.utc.beginning_of_day - 30.days).to_i * 1000,
        to: Time.now.utc.beginning_of_day.to_i * 1000
    }]
  })
  g.raw_option(%(yAxis: {
    title: {
      text: 'Video-page views',
      margin: 70
    },
    min: 0,
    labels: {
      formatter: function() { return Highcharts.numberFormat(this.value, 0); }
    }
  }))
  g.raw_option(%(tooltip: {
    formatter: function() {
      var date = "<strong>" + Highcharts.dateFormat("%B %e,  %Y", this.x) + "</strong><br/>";
      var percentage_of_total = '';
      var loader_per_player = '';
      var total = '';

      if (["Invalid", "Invalid cached", "Dev", "Dev cached", "Main", "Main cached"].indexOf(this.series.name) != -1) {
        percentage_of_total = " (" + Highcharts.numberFormat(this.percentage, 1) + "%)";
        total = "<br/>Total: " + Highcharts.numberFormat(this.total, 0);
      }
      else if (this.series.name == "Loader") {
        loader_per_player = "<br/>Loader / Player: " + Highcharts.numberFormat((this.y / (this.total - this.y)), 1);
      }

      return date + this.series.name + ": " + Highcharts.numberFormat(this.y, 0) + percentage_of_total + loader_per_player + total;
    }
  }))
  g.option(series: [
    serie(usages["loader_usage"], 'Loader', '#AAAA00', visible: false),
    serie(usages["invalid_usage_cached"], 'Invalid cached', '#FF8800', visible: false),
    serie(usages["invalid_usage"], 'Invalid', '#FF0000', visible: false),
    serie(usages["dev_usage_cached"], 'Dev cached', '#11CC11', visible: false),
    serie(usages["dev_usage"], 'Dev', '#33FF33', visible: false),
    serie(usages["main_usage_cached"], 'Main cached', '#0088FF'),
    serie(usages["main_usage"], 'Main', '#0000FF'),

    serie(evolutive_average_array(usages["total_loader_usage"]), 'AVG Loader', '#FFFF00', type: 'line', visible: false),
    serie(evolutive_average_array(usages["total_invalid_usage"]), 'AVG Invalid', '#FFCC33', type: 'line', visible: false),
    serie(evolutive_average_array(usages["total_dev_usage"]), 'AVG Dev', '#66FF66', type: 'line', visible: false),
    serie(evolutive_average_array(usages["total_main_usage"].zip(usages["main_usage_cached"]).map { |item| item.reduce(:+) }), 'AVG Main', '#00FFFF', :type => 'line'),

    serie(usages["total_main_usage"], 'TOT Main', '', type: 'line', visible: false),
    serie(usages["total_all_usage"], 'TOT All', '', type: 'line', visible: false),

    plans.inject([]) do |memo, plan|
      memo << serie(Array.new(usages["main_usage"].size, plan.player_hits / 30), "AVG #{plan.name.humanize}", '', type: 'line', visible: false); memo
    end,

    plans.inject([]) do |memo, plan|
      memo << serie(Array.new(usages["main_usage"].size, plan.player_hits), "LIM #{plan.name.humanize}", '', type: 'line', visible: false); memo
    end
  ].flatten)
  g.option(plotOptions: plot_options(@date_range_from))
  g.option(credits: credits)
end
%>
<div id="timeline_usage" style="width: 100%; height: 300px;"><%= raw graph.draw %></div>
