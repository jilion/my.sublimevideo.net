class MailLetter
  extend ActiveModel::Naming

  def initialize(params)
    @template = MailTemplate.find(params[:template_id])
    @admin_id, @criteria = params[:admin_id], params[:criteria]
  end

  # ====================
  # = Instance Methods =
  # ====================

  def deliver_and_log
    return nil if @template.blank? || @admin_id.blank? || @criteria.blank?

    users = case @criteria
            when 'dev'
              User.where(:email => ["thibaud@jilion.com", "remy@jilion.com", "zeno@jilion.com", "octave@jilion.com"])
            when 'all'
              User.all
            when 'rollbacked_beta_with_usage'
              User.where(id: [20, 21, 26, 27, 29, 41, 50, 52, 60, 78, 81, 91, 97, 109, 115, 116, 128, 139, 144, 152, 166, 172, 173, 184, 202, 205, 217, 232, 260, 280, 281, 282, 283, 308, 313, 326, 336, 346, 361, 379, 386, 406, 411, 418, 449, 452, 454, 479, 484, 489, 493, 495, 506, 531, 535, 537, 543, 550, 554, 558, 565, 591, 601, 606, 608, 610, 622, 631, 632, 637, 646, 673, 678, 685, 694, 696, 703, 705, 719, 724, 727, 752, 753, 767, 768, 777, 805, 820, 828, 829, 837, 843, 847, 852, 861, 866, 877, 881, 887, 893, 905, 908, 915, 919, 924, 932, 945, 961, 976, 1016, 1019, 1039, 1044, 1045, 1073, 1084, 1085, 1090, 1095, 1106, 1117, 1128, 1158, 1169, 1202, 1207, 1222, 1228, 1237, 1238, 1246, 1251, 1252, 1265, 1289, 1308, 1319, 1323, 1328, 1333, 1338, 1341, 1358, 1421, 1424, 1426, 1429, 1440, 1442, 1446, 1460, 1464, 1475, 1476, 1477, 1499, 1502, 1536, 1552, 1587, 1612, 1632, 1634, 1635, 1658, 1694, 1727, 1748, 1753, 1762, 1772, 1793, 1837, 1838, 1845, 1852, 1872, 1876, 1920, 1933, 1947, 1958, 1964, 1997, 2020, 2023, 2024, 2029, 2032, 2040, 2043, 2046, 2070, 2080, 2083, 2095, 2098, 2161, 2163, 2165, 2166, 2178, 2183, 2207, 2228, 2246, 2250, 2336, 2338, 2371, 2379, 2415, 2421, 2422, 2437, 2442, 2455, 2463, 2464, 2470, 2478, 2484, 2494, 2519, 2571, 2589, 2607, 2631, 2649, 2652, 2671, 2687, 2710, 2726, 2731, 2763, 2764, 2769, 2774, 2784, 2786, 2802, 2803, 2840, 2857, 2858, 2862, 2879, 2886, 2910, 2930, 2934, 2935, 2943, 2952, 2995, 3023, 3038, 3039, 3044, 3070, 3083, 3089, 3099, 3104, 3115, 3124, 3142, 3143, 3157, 3174, 3190, 3192, 3199, 3207, 3210, 3225, 3238, 3240, 3315, 3322, 3367, 3371, 3378, 3379, 3396, 3402, 3418, 3429, 3448, 3467, 3476, 3479, 3493, 3526, 3536, 3544, 3549, 3556, 3565, 3574, 3576, 3625, 3629, 3631, 3636, 3654, 3667, 3670, 3674, 3678, 3682, 3692, 3693, 3720, 3736, 3750, 3757, 3767, 3771, 3778, 3788, 3789, 3814, 3822, 3851, 3873, 3875, 3879, 3905, 3907, 3924, 3927, 3928, 3934, 3954, 3963, 3964, 3983, 3985, 3998, 4015, 4021, 4039, 4052, 4106, 4114, 4116, 4126, 4130, 4134, 4141, 4143, 4147, 4168, 4171, 4176, 4203, 4215, 4216, 4230, 4252, 4253, 4254, 4276, 4290, 4312, 4315, 4318, 4322, 4350, 4360, 4370, 4376, 4403, 4411, 4437, 4438, 4453, 4456, 4471, 4485, 4487, 4515, 4519, 4538, 4542, 4559, 4569, 4573, 4603, 4623, 4626, 4647, 4660, 4662, 4682, 4718, 4724, 4756, 4796, 4798, 4821, 4831, 4850, 4852, 4878, 4882, 4883, 4893, 4913, 4927, 4935, 4955, 4985, 4996, 5029, 5045, 5058, 5067, 5074, 5088, 5091, 5092, 5093, 5095, 5147, 5149, 5161, 5177, 5188, 5203, 5212, 5213, 5214, 5216, 5228, 5233, 5238, 5262, 5271, 5272, 5290, 5293, 5304, 5310, 5320, 5325, 5338, 5352, 5366, 5382, 5408, 5410, 5411, 5423, 5427, 5443, 5468, 5477, 5483, 5492, 5519, 5529, 5566, 5591, 5610, 5634, 5646, 5671, 5700, 5735, 5756, 5770, 5772, 5784, 5817, 5823, 5846, 5863, 5872, 5880, 5886, 5889, 5892, 5893, 5898, 5908, 5918, 5972, 5976, 6013, 6027, 6042, 6054, 6056, 6058, 6145, 6167, 6175, 6189, 6195, 6215, 6222, 6240, 6274, 6292, 6294, 6295, 6308, 6333, 6339, 6346, 6355, 6363, 6400, 6403, 6421, 6425, 6426, 6437, 6441, 6464, 6479, 6485, 6488, 6489, 6492, 6513, 6573, 6579, 6590, 6595, 6596, 6616, 6654, 6673, 6675, 6680, 6684, 6716, 6781, 6791, 6812, 6819, 6848, 6887, 6902, 6927, 6929, 6947, 6952, 6968, 6972, 6974, 6982, 7004, 7022, 7034, 7036, 7037, 7045, 7079, 7108, 7114, 7123, 7138, 7157, 7159, 7162, 7169, 7170, 7227, 7236, 7260, 7275, 7280, 7323, 7351, 7382, 7391, 7394, 7396, 7422, 7450, 7456, 7468, 7471, 7475, 7476, 7482, 7497, 7499, 7518, 7531, 7568, 7574, 7587, 7608, 7611, 7620, 7621, 7684, 7700, 7704, 7723, 7730, 7742, 7757, 7763, 7766, 7769, 7790, 7820, 7822, 7842, 7863, 7868, 7871, 7886, 7914, 7961, 7982, 7986, 7990, 8011, 8026, 8041, 8049, 8060, 8069, 8075, 8091, 8095, 8121, 8128, 8143, 8152, 8165, 8172, 8179, 8193, 8212, 8237, 8271, 8273, 8277, 8288, 8289, 8316, 8370, 8393, 8423, 8428, 8430, 8448, 8461, 8463, 8478, 8480, 8507, 8531, 8535, 8541, 8549, 8571, 8578, 8656, 8660, 8667, 8673, 8677, 8699, 8704, 8707, 8709, 8711, 8718, 8730, 8748, 8756, 8761, 8762, 8765, 8769, 8770, 8782, 8796, 8829, 8843, 8856, 8862, 8872, 8877, 8922, 8965, 8967, 8970, 8974, 8982, 8985, 8990, 9003, 9012, 9035, 9050, 9052, 9062, 9072, 9080, 9081, 9119, 9184, 9186, 9188, 9191, 9196, 9203, 9204, 9205, 9210, 9222, 9244, 9246, 9250, 9256, 9259, 9270, 9273, 9278, 9279, 9296, 9304, 9318, 9321, 9325, 9326, 9330, 9333, 9346, 9347, 9366, 9374, 9376, 9377, 9386, 9392, 9405, 9413, 9425, 9452, 9505, 9508, 9510, 9522, 9529, 9562, 9569, 9573, 9575, 9592, 9603, 9609, 9611, 9614])
            else
              User.send(@criteria)
            end

    users.uniq.each { |u| self.class.delay.deliver(u, @template) }

    unless @criteria == 'dev'
      @template.logs.create(:admin_id => @admin_id, :criteria => @criteria, :user_ids => users.map(&:id))
    end
  end

private

  def self.deliver(user, template)
    MailMailer.send_mail_with_template(user, template).deliver
  end

end
